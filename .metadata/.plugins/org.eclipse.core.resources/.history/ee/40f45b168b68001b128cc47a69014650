package CustomerSimulator.models;

import java.util.ArrayList;
import java.util.Observable;

import CustomerSimulator.views.StoreView;
import random.ExponentialRandomStream;
import random.UniformRandomStream;

public class Store extends Observable{
	private boolean simRunning;
	private int maxPeople;
	private double timeOpen;
    private double lambda;
    private double[] pickMinMax;
    private double[] payMinMax;
    private long seed;
    private int peopleInStore = 0;
    private int totalAmountOfCustomers = 0;
    private int missedCustomers = 0;
    private ArrayList<Customer> CustomerID = new ArrayList<Customer>();
    private double currentTime = 0.0;
    private int totAmOfRegs;
    private ExponentialRandomStream ArrivalTime;
    private UniformRandomStream PickTime;
    private UniformRandomStream PayTime;
    private int customersDone = 0;
    private ArrayList<PayQueue> payQueue = new ArrayList<PayQueue>();
    private double[] cashierTotalTime;
    
	public Store(double timeOpen, int cashiers, int maxPeople, double lambda, double[] pickMinMax, double[] payMinMax, long seed) {
		this.totAmOfRegs = cashiers;
        this.maxPeople = maxPeople;
        this.lambda = lambda;
        this.pickMinMax = pickMinMax;
        this.payMinMax = payMinMax;
        this.seed = seed;
        this.ArrivalTime = new ExponentialRandomStream(lambda,seed);
        this.PickTime = new UniformRandomStream(pickMinMax[0], pickMinMax[1], seed);
        this.PayTime = new UniformRandomStream(payMinMax[0], payMinMax[1], seed);
        this.simRunning = true;
        this.timeOpen = timeOpen;
        for(int i = 0; i < totAmOfRegs; i++) {
        	payQueue.add(new PayQueue(i));
        }
        this.cashierTotalTime = new double[cashiers];
        addObserver(new StoreView());
	}
	
	public double getNextArrived() {
        return ArrivalTime.next();
    }
	
	public double getNextPickTime() {
        return PickTime.next();
    }

    public double getNextPayTime() {
        return PayTime.next();
    }
    public void closeStore() {
    	this.simRunning = false;
    }
    
    public double getMaxTime() {
    	return timeOpen;
    }
    
    public boolean getStatus() {
    	return this.simRunning;
    }
    
    public int getNewCustomerId() {
    	return this.CustomerID.size();
    }
    public void addCustomer(Customer c) {
    	this.CustomerID.add(c);
    }
    public int getPeopleInStore() {
        return peopleInStore;
    }

    public int getMaxPeople() {
        return maxPeople;
    }

    public void increasePeopleInStore() {
        peopleInStore++;
    }

    public void decreasePeopleInStore() {
        peopleInStore--;
    }
    
    public int toQueue(int id) {
    	int leastAmmountID = 0;
    	int leastAmmountQueue = 0;
    	for(int i = 0; i < payQueue.size(); i++) {
    		if(i == 0) {
    			leastAmmountID = i;
    			leastAmmountQueue = payQueue.get(i).getPayQueueSize();
    		}
    		else if(payQueue.get(i).getPayQueueSize() < leastAmmountQueue) {
    			leastAmmountID = i;
    			leastAmmountQueue = payQueue.get(i).getPayQueueSize();
    		}
    	}
    	payQueue.get(leastAmmountID).toQueue(id);
    	return leastAmmountID;
    	
    }
    
    public PayQueue getQueue(int id) {
    	return payQueue.get(id);
    }
    
    public void increaseTotAmountOfCustomers() {
        totalAmountOfCustomers++;
    }
    
    public int getTotAmountOfCustomers() {
        return totalAmountOfCustomers;
    }

    public void increaseMissedCustomers() {
        missedCustomers++;
    }
    
    public int getTotmissedCustomers() {
        return missedCustomers;
    }

    public double setTotalTimeQueue() {
    	for(int i = 0; i < payQueue.size(); i++) {
    		this.cashierTotalTime[i] = payQueue.get(i).getTotalTime();    	
    	}

    	int sum = 0;
        for(double i: this.cashierTotalTime){
          sum += i;
        }
        return sum;
    }
    
    public double freeCashierTime() {
    	return this.timeOpen - setTotalTimeQueue();
    }
    
    public void update() {
    	setChanged();
    	notifyObservers();
    }
}